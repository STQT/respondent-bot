from datetime import timezone

from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.types import Message, PollAnswer
from asgiref.sync import sync_to_async
from django.utils.translation import gettext_lazy as _

from apps.bot.states import PollStates
from apps.bot.utils import get_current_question, get_next_question
from apps.polls.models import Answer, Question, Respondent, Poll
from apps.users.models import TGUser

start_router = Router()


@start_router.message(CommandStart(deep_link=True))
async def command_start_handler(message: Message, state: FSMContext, user: TGUser | None, command):
    poll_uuid = None
    if command.args and command.args.startswith("poll_"):
        poll_uuid = command.args.removeprefix("poll_")

    if poll_uuid:
        poll = await Poll.objects.filter(uuid=poll_uuid, deadline__gte=timezone.now()).afirst()
        if not poll:
            await message.answer(str(_("–ö–µ—á–∏—Ä–∞—Å–∏–∑, —É—à–±—É —Å—û—Ä–æ–≤–Ω–æ–º–∞ —Ç–æ–ø–∏–ª–º–∞–¥–∏ —ë–∫–∏ –º—É–¥–¥–∞—Ç–∏ —Ç—É–≥–∞–≥–∞–Ω.")))
            return

        respondent = await Respondent.objects.filter(tg_user=user, poll=poll).afirst()

        if respondent:
            if respondent.finished_at:
                # ‚úÖ –£–∂–µ –ø—Ä–æ—à–µ–ª ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
                markup = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üîÅ “ö–∞–π—Ç–∞ –±–æ—à–ª–∞—à", callback_data=f"poll_restart:{poll.uuid}")]
                ])
                await message.answer(str(_("–°–∏–∑ –±—É —Å—û—Ä–æ–≤–Ω–æ–º–∞–Ω–∏ –∞–≤–≤–∞–ª —è–∫—É–Ω–ª–∞–≥–∞–Ω—Å–∏–∑.")), reply_markup=markup)
            else:
                # üîÅ –ù–µ –æ–∫–æ–Ω—á–µ–Ω ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                markup = InlineKeyboardMarkup(inline_keyboard=[
                    [
                        InlineKeyboardButton(text="üîÑ –î–∞–≤–æ–º —ç—Ç–∏—à", callback_data=f"poll_continue:{poll.uuid}"),
                        InlineKeyboardButton(text="‚ôªÔ∏è “ö–∞–π—Ç–∞ –±–æ—à–ª–∞—à", callback_data=f"poll_restart:{poll.uuid}")
                    ]
                ])
                await message.answer(
                    str(_("–°–∏–∑ —Å—û—Ä–æ–≤–Ω–æ–º–∞–Ω–∏ —Ç—û–ª–∏“õ —è–∫—É–Ω–ª–∞–º–∞–≥–∞–Ω—Å–∏–∑. –î–∞–≤–æ–º —ç—Ç–∞—Å–∏–∑–º–∏ —ë–∫–∏ “õ–∞–π—Ç–∞ –±–æ—à–ª–∞–π—Å–∏–∑–º–∏?")),
                    reply_markup=markup)
        else:
            # ‚ú≥Ô∏è –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å
            await get_current_question(message.bot, message.from_user.id, state, user, poll_uuid=poll_uuid)
    else:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
        await get_current_question(message.bot, message.from_user.id, state, user)


@start_router.callback_query(lambda c: c.data.startswith("poll_"))
async def poll_callback_handler(callback, state: FSMContext, user: TGUser | None):
    action, poll_uuid = callback.data.split(":", 1)
    poll = await Poll.objects.filter(uuid=poll_uuid, deadline__gte=timezone.now()).afirst()

    if not poll:
        await callback.message.edit_text(str(_("–ö–µ—á–∏—Ä–∞—Å–∏–∑, —É—à–±—É —Å—û—Ä–æ–≤–Ω–æ–º–∞ —Ç–æ–ø–∏–ª–º–∞–¥–∏ —ë–∫–∏ –º—É–¥–¥–∞—Ç–∏ —Ç—É–≥–∞–≥–∞–Ω.")))
        return

    if action == "poll_continue":
        await callback.message.delete()
        await get_current_question(callback.bot, callback.from_user.id, state, user, poll_uuid=poll_uuid)
    elif action == "poll_restart":
        # ‚ùó –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–∞ –∏ –µ–≥–æ –æ—Ç–≤–µ—Ç—ã
        await Answer.objects.filter(respondent__tg_user=user, respondent__poll=poll).adelete()
        await Respondent.objects.filter(tg_user=user, poll=poll).adelete()

        await callback.message.delete()
        await get_current_question(callback.bot, callback.from_user.id, state, user, poll_uuid=poll_uuid)


@start_router.poll_answer()
async def handle_poll_answer(poll_answer: PollAnswer, state: FSMContext, user: TGUser | None):
    print("WORKING")
    telegram_poll_id = poll_answer.poll_id

    try:
        answer = await Answer.objects.select_related("question", "respondent").aget(
            telegram_poll_id=telegram_poll_id
        )
    except Answer.DoesNotExist:
        print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω answer –ø–æ poll_id")
        return

    if not poll_answer.option_ids:
        print("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª, –ø–æ–≤—Ç–æ—Ä—è–µ–º –≤–æ–ø—Ä–æ—Å")
        unfinished_answer = await Answer.objects.select_related("question", "respondent").filter(
            respondent__tg_user=user,
            is_answered=False,
            telegram_msg_id__isnull=False
        ).order_by("-id").afirst()
        await poll_answer.bot.delete_message(chat_id=unfinished_answer.telegram_chat_id,
                                             message_id=unfinished_answer.telegram_msg_id)
        await get_current_question(poll_answer.bot, poll_answer.user.id, state, user)
        return
    selected_index = poll_answer.option_ids[0]

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
    choices = await sync_to_async(list)(
        answer.question.choices.all().order_by("order")
    )

    is_mixed = answer.question.type == Question.QuestionTypeChoices.MIXED

    if is_mixed and selected_index == len(choices):
        # –í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç "–ë–æ—à“õ–∞"
        print("IS MIXED")
        await state.update_data(
            answer_id=answer.id,
            respondent_id=answer.respondent_id,
            question_id=answer.question_id
        )
        await poll_answer.bot.send_message(
            poll_answer.user.id,
            "üìù –ò–ª—Ç–∏–º–æ—Å, —û–∑ –∂–∞–≤–æ–±–∏–Ω–≥–∏–∑–Ω–∏ –º–∞—Ç–Ω —Å–∏—Ñ–∞—Ç–∏–¥–∞ —é–±–æ—Ä–∏–Ω–≥:"
        )
        await state.set_state(PollStates.waiting_for_mixed_custom_input)
        return

    # –û–±—ã—á–Ω—ã–π –≤—ã–±–æ—Ä ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    try:
        selected_choice = choices[selected_index]
    except IndexError:
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –æ–ø—Ü–∏–∏")
        return

    await answer.selected_choices.aadd(selected_choice)
    answer.is_answered = True
    await answer.asave()

    print(f"‚úÖ User {answer.respondent.tg_user_id} –≤—ã–±—Ä–∞–ª: {selected_choice.text}")
    await poll_answer.bot.delete_message(chat_id=answer.telegram_chat_id, message_id=answer.telegram_msg_id)
    # –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
    await get_next_question(poll_answer.bot, poll_answer.user.id, state, answer.respondent,
                            answer.respondent.history, answer.question_id)


@start_router.message(PollStates.waiting_for_mixed_custom_input)
async def handle_custom_input_for_mixed(message: Message, state: FSMContext):
    print("HANDLING")
    data = await state.get_data()
    answer_id = data.get("answer_id")

    try:
        answer = await Answer.objects.select_related("respondent").aget(id=answer_id)
    except Answer.DoesNotExist:
        await message.answer("‚ùå –ñ–∞–≤–æ–±–Ω–∏ —Å–∞“õ–ª–∞—à–¥–∞ —Ö–∞—Ç–æ —é–∑ –±–µ—Ä–¥–∏.")
        return

    answer.open_answer = message.text.strip()
    await answer.asave()
    await message.answer("‚úÖ –ñ–∞–≤–æ–± “õ–∞–±—É–ª “õ–∏–ª–∏–Ω–¥–∏!")

    await get_next_question(message.bot, message.chat.id, state, answer.respondent, answer.respondent.history,
                            answer.question_id)
