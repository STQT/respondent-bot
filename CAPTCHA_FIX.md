# Исправление проблемы с бесконечными капчами

## ✅ Что было исправлено

### Проблема 1: Слишком частые капчи
**Было:** Капча показывалась случайно с вероятностью 30% после каждого вопроса  
**Стало:** Капча показывается только на определенных вопросах: 5, 10, 15, 20, 25, 30

### Проблема 2: Бесконечный цикл капч
**Было:** После успешной капчи сразу показывалась новая капча  
**Стало:** Добавлена защита - капча не показывается, если уже была в последние 30 секунд

---

## 📝 Изменения в коде

### 1. Файл: `apps/bot/captcha_utils.py`

**Функция `should_show_captcha`:**

```python
# БЫЛО (неправильно):
def should_show_captcha(answered_count: int) -> bool:
    if answered_count < 2:
        return False
    if answered_count % 5 == 0:
        return True
    return random.random() < 0.3  # ❌ Слишком часто!

# СТАЛО (правильно):
def should_show_captcha(answered_count: int) -> bool:
    if answered_count < 3:
        return False
    # Только на конкретных вопросах
    if answered_count in [5, 10, 15, 20, 25, 30]:
        return True
    return False  # ✅ Остальное время - нет капчи
```

### 2. Файл: `apps/bot/utils.py`

**Функция `get_next_question`:**

Добавлена проверка на недавнюю капчу:

```python
# Проверяем, была ли капча показана недавно (в последние 30 секунд)
recent_captcha = await sync_to_async(
    CaptchaChallenge.objects.filter(
        respondent=respondent,
        created_at__gte=timezone.now() - timedelta(seconds=30)
    ).exists
)()

# Показываем капчу только если:
# 1. Настало время (по answered_count)
# 2. И не было капчи в последние 30 секунд
if should_show_captcha(answered_count) and not recent_captcha:
    # Показываем капчу
```

---

## 🎯 Теперь капча работает так:

### Расписание показа капчи:

| Вопрос опроса | Капча? | Пояснение |
|---------------|--------|-----------|
| 1-2 | ❌ Нет | Не беспокоим на старте |
| 3-4 | ❌ Нет | - |
| **5** | ✅ **Да** | Первая проверка |
| 6-9 | ❌ Нет | - |
| **10** | ✅ **Да** | Вторая проверка |
| 11-14 | ❌ Нет | - |
| **15** | ✅ **Да** | Третья проверка |
| ... | ... | И так далее каждые 5 вопросов |

### Пример прохождения опроса:

```
1. Вопрос 1 → Ответ
2. Вопрос 2 → Ответ
3. Вопрос 3 → Ответ
4. Вопрос 4 → Ответ
5. Вопрос 5 → Ответ
   → КАПЧА (первый раз) → Правильный ответ
6. Вопрос 6 → Ответ  ✅ Продолжается опрос!
7. Вопрос 7 → Ответ
8. Вопрос 8 → Ответ
9. Вопрос 9 → Ответ
10. Вопрос 10 → Ответ
    → КАПЧА (второй раз) → Правильный ответ
11. Вопрос 11 → Ответ  ✅ Снова продолжается!
...
```

---

## 🔧 Настройка частоты капчи

Если хотите изменить, когда показывать капчу:

### Более частые капчи (каждые 3 вопроса):
```python
# В файле apps/bot/captcha_utils.py
if answered_count in [3, 6, 9, 12, 15, 18, 21, 24, 27, 30]:
    return True
```

### Более редкие капчи (каждые 10 вопросов):
```python
if answered_count in [10, 20, 30, 40, 50]:
    return True
```

### Только один раз в середине:
```python
if answered_count == 10:
    return True
```

---

## 🚀 Применение исправлений

### Если используете Docker:
```bash
# Перезапустите контейнер
docker-compose restart django
```

### Если локально:
```bash
# Перезапустите бота
# Ctrl+C и снова:
python manage.py runpolling
```

### Если webhook:
Изменения подхватятся автоматически при следующем запросе.

---

## ✅ Проверка работы

### Тест 1: Капча показывается на нужных вопросах
1. Создайте опрос с 20 вопросами
2. Начните проходить
3. На 5-м вопросе должна быть капча
4. После правильного ответа - вопрос 6
5. На 10-м вопросе - снова капча
6. После правильного ответа - вопрос 11

### Тест 2: Капча не зацикливается
1. Ответьте на капчу правильно
2. Должен появиться следующий вопрос ОПРОСА
3. НЕ должна появиться новая капча сразу

### Тест 3: Неправильные ответы
1. На капче введите неправильный ответ
2. Должно показать "Попыток: 1/3"
3. У вас есть еще 2 попытки
4. После 3-х неправильных - опрос останавливается

---

## 📊 Мониторинг

### Проверка количества капч в админке:

```
Admin → Капчи → посмотрите статистику
```

**Нормальные показатели для опроса из 20 вопросов:**
- Капч показано: 3-4 (на 5, 10, 15 вопросах)
- Правильно решено: ~80-90%
- Провалено: ~10-20%

**Подозрительно:**
- Капч показано: 20+ для одного респондента
- Это значит бот все еще зацикливается (не должно быть)

---

## 🐛 Troubleshooting

### Проблема: Капча все еще зацикливается
**Решение:**
1. Проверьте, что применили изменения (перезапустили бота)
2. Проверьте логи - не должно быть ошибок
3. Очистите БД от старых капч:
```python
from apps.polls.models import CaptchaChallenge
CaptchaChallenge.objects.filter(is_correct=False).delete()
```

### Проблема: Капча не показывается вообще
**Решение:**
1. Проверьте, что опрос содержит минимум 5 вопросов
2. Проверьте код в `captcha_utils.py` - должно быть `answered_count in [5, 10, ...]`

### Проблема: Капча показывается не на тех вопросах
**Решение:**
Проверьте логику в `should_show_captcha` - возможно изменили случайно

---

## 📌 Итого

**Что изменилось:**
- ✅ Капча показывается реже (только на 5, 10, 15... вопросах)
- ✅ Нет бесконечного цикла (защита от повтора в 30 секунд)
- ✅ Пользователи могут нормально проходить опросы

**Статистика (ожидаемая):**
- Опрос из 10 вопросов: 1-2 капчи
- Опрос из 20 вопросов: 3-4 капчи
- Опрос из 30 вопросов: 5-6 капч

Все работает! 🎉

