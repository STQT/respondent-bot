# Система массовой рассылки постов

## Описание

Система позволяет отправлять посты всем активным пользователям Telegram бота. Поддерживает как текстовые сообщения, так и сообщения с изображениями.

## Возможности

- ✅ **Массовая рассылка** - отправка постов всем активным пользователям
- ✅ **Поддержка изображений** - можно прикреплять картинки к постам
- ✅ **HTML разметка** - поддержка жирного текста и других HTML тегов
- ✅ **Статистика** - отслеживание прогресса и успешности рассылки
- ✅ **Разбивка на группы** - автоматическое разделение пользователей на группы по 100
- ✅ **Обработка ошибок** - продолжение рассылки при ошибках
- ✅ **Админ интерфейс** - удобное управление через Django Admin

## Использование

### 1. Создание поста

1. Зайдите в Django Admin (`/admin/`)
2. Перейдите в раздел "Посты для рассылки"
3. Нажмите "Добавить пост для рассылки"
4. Заполните поля:
   - **Заголовок** - заголовок поста (будет выделен жирным)
   - **Содержание** - основной текст поста
   - **Изображение** - опционально, картинка для поста
   - **Время отправки** - опционально, для отложенной отправки

### 2. Запуск рассылки

1. Выберите пост в списке
2. Нажмите "Запустить рассылку" в действиях
3. Или откройте пост и нажмите "Сохранить и продолжить редактирование"

### 3. Мониторинг

- **Статус** - текущее состояние рассылки
- **Прогресс** - процент выполненных отправок
- **Успешность** - процент успешных отправок
- **Статистика** - количество отправленных и неудачных сообщений

## Статусы постов

- **Черновик** - пост создан, но не отправлен
- **Запланировано** - пост запланирован на определенное время
- **Отправляется** - рассылка в процессе
- **Отправлено** - рассылка завершена
- **Ошибка** - произошла ошибка при рассылке

## Технические детали

### Модель BroadcastPost

```python
class BroadcastPost(models.Model):
    title = models.CharField(max_length=255)  # Заголовок
    content = models.TextField()              # Содержание
    image = models.ImageField()               # Изображение
    status = models.CharField()               # Статус
    total_users = models.IntegerField()       # Всего пользователей
    sent_users = models.IntegerField()        # Отправлено
    failed_users = models.IntegerField()      # Ошибок
    # ... другие поля
```

### Celery задачи

- `start_broadcast_task` - основная задача запуска рассылки
- `send_broadcast_chunk_task` - отправка группе пользователей

### Безопасность

- Разбивка на группы по 100 пользователей
- Задержка 1 секунда между отправками
- Задержка 2 секунды между группами
- Обработка ошибок без остановки рассылки

## Команды для тестирования

```bash
# Тест системы (без создания поста)
docker-compose -f docker-compose.local.yml exec django python manage.py test_broadcast --dry-run

# Создание тестового поста
docker-compose -f docker-compose.local.yml exec django python manage.py test_broadcast --title "Тест" --content "Тестовое сообщение"
```

## Требования

- Настроенный токен бота в `.env`
- Запущенный Celery worker
- Активные пользователи в базе данных

## Устранение проблем

### Ошибка "Unauthorized"
- Проверьте токен бота в файле `.env`
- Убедитесь, что токен получен от @BotFather

### Рассылка не запускается
- Проверьте, что Celery worker запущен
- Проверьте логи: `docker-compose logs celeryworker`

### Нет пользователей для рассылки
- Убедитесь, что есть активные пользователи: `TGUser.objects.filter(is_active=True).count()`
